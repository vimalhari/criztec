---
import { APP_BLOG } from 'criztec:config';
import type { Post } from '~/types';

import Image from '~/components/common/Image.astro';

import { findImage } from '~/utils/images';
import { getPermalink } from '~/utils/permalinks';

export interface Props {
  post: Post;
}

const { post } = Astro.props;
const image = await findImage(post.image);

const link = APP_BLOG?.post?.isEnabled ? getPermalink(post.permalink, 'post') : '';
---

<article
  class="h-full flex flex-col bg-white dark:bg-slate-800 rounded-xl shadow-sm hover:shadow-md transition-all duration-200 overflow-hidden intersect-once intersect-quarter motion-safe:md:opacity-0 motion-safe:md:intersect:animate-fade group"
>
  <div class="relative aspect-square bg-gray-400 dark:bg-slate-700 overflow-hidden">
    {
      image &&
        (link ? (
          <a href={link} class="block h-full">
            <Image
              src={image}
              class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300"
              widths={[400, 600]}
              width={400}
              sizes="(max-width: 640px) 100vw, (max-width: 1024px) 50vw, 33vw"
              alt={post.title}
              aspectRatio="1:1"
              layout="cover"
              loading="lazy"
              decoding="async"
            />
          </a>
        ) : (
          <Image
            src={image}
            class="w-full h-full object-cover"
            widths={[400, 600]}
            width={400}
            sizes="(max-width: 640px) 100vw, (max-width: 1024px) 50vw, 33vw"
            alt={post.title}
            aspectRatio="16:9"
            layout="cover"
            loading="lazy"
            decoding="async"
          />
        ))
    }
  </div>

  <div class="flex-1 flex flex-col p-5">
    <h3 class="text-base sm:text-lg font-semibold leading-snug mb-2 font-heading dark:text-slate-300 line-clamp-2">
      {
        link ? (
          <a
            class="inline-block hover:text-primary dark:hover:text-orange-400 transition ease-in duration-200"
            href={link}
          >
            {post.title}
          </a>
        ) : (
          post.title
        )
      }
    </h3>

    <p class="text-muted dark:text-slate-400 text-sm flex-1 line-clamp-3 mb-4">{post.excerpt}</p>

    <div class="flex items-center justify-between mt-auto pt-4 border-t border-gray-100 dark:border-slate-700">
      {
        post.publishDate && (
          <div class="text-xs text-gray-500 dark:text-gray-400">
            {new Date(post.publishDate).toLocaleDateString('en-US', {
              year: 'numeric',
              month: 'short',
              day: 'numeric',
            })}
          </div>
        )
      }

      {
        post.category && (
          <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-primary/10 text-primary dark:bg-primary/20">
            {post.category.title}
          </span>
        )
      }
    </div>
  </div>
</article>
