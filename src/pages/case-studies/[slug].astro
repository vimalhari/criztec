---
import { getCollection, type CollectionEntry, render } from 'astro:content';
import Layout from '~/layouts/PageLayout.astro';
import CallToAction from '~/components/widgets/CallToAction.astro';
import CaseStudyHero from '~/components/case-study/CaseStudyHero.astro';
import CaseStudyOverview from '~/components/case-study/CaseStudyOverview.astro';
import CaseStudyTestimonial from '~/components/case-study/CaseStudyTestimonial.astro';
import RelatedCaseStudies from '~/components/case-study/RelatedCaseStudies.astro';

// Import custom case study styles
import '~/styles/case-studies.css';

export async function getStaticPaths() {
  const caseStudies = await getCollection('case-studies', ({ id, data }) => {
    // Exclude draft studies and template files
    return !data.draft && !id.startsWith('_');
  });
  return caseStudies.map((study) => ({
    params: { slug: study.id },
    props: { study },
  }));
}

type Props = {
  study: CollectionEntry<'case-studies'>;
};

const { study } = Astro.props;
const { Content } = await render(study);

// Get related case studies (same category or similar tags, excluding current)
const allCaseStudies = await getCollection('case-studies', ({ id, data }) => {
  return !data.draft && !id.startsWith('_') && id !== study.id;
});

// Generate metadata
const metadata = {
  title: `${study.data.title} - Case Study | Criztec Technologies`,
  description: study.data.description,
  canonical: `https://criztec.com/case-studies/${study.id}`,
  robots: {
    index: true,
    follow: true,
  },
  openGraph: {
    type: 'article',
    title: study.data.title,
    description: study.data.description,
    image: study.data.heroImage || 'https://assets.criztec.com/hero-image.webp',
  },
};
---

<Layout metadata={metadata}>
  <!-- Hero Section -->
  <CaseStudyHero study={study} />

  <!-- Project Overview -->
  <CaseStudyOverview study={study} />

  <!-- Detailed Content -->
  <section class="case-study-section px-4 py-12 mx-auto max-w-4xl lg:px-8">
    <div class="prose prose-lg dark:prose-invert max-w-none prose-headings:font-semibold prose-a:text-primary">
      <Content />
    </div>
  </section>

  <!-- Features Showcase - Simplified -->
  <section id="features" class="px-4 py-12 mx-auto max-w-7xl lg:px-8 bg-gray-50 dark:bg-gray-900/50">
    <h2 class="text-2xl md:text-3xl lg:text-[2rem] font-bold text-gray-900 dark:text-white mb-8 text-center">
      Key Features
    </h2>

    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
      {
        study.data.features.map((feature) => (
          <div class="bg-white dark:bg-gray-800 rounded-lg p-6 border border-gray-200 dark:border-gray-700">
            <div class="w-10 h-10 bg-primary/10 rounded-lg flex items-center justify-center mb-4">
              <svg class="w-5 h-5 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
              </svg>
            </div>
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-2">{feature.title}</h3>
            <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">{feature.description}</p>
            <ul class="space-y-1.5">
              {feature.benefits.slice(0, 3).map((benefit) => (
                <li class="flex items-center gap-2 text-sm text-gray-600 dark:text-gray-400">
                  <span class="w-1 h-1 bg-primary rounded-full flex-shrink-0" />
                  {benefit}
                </li>
              ))}
            </ul>
          </div>
        ))
      }
    </div>
  </section>

  <!-- Testimonial -->
  <CaseStudyTestimonial study={study} />

  <!-- Technologies & Tags Combined -->
  <section class="px-4 py-8 mx-auto max-w-7xl lg:px-8">
    <div class="flex flex-wrap justify-center gap-2">
      {
        study.data.tags &&
          study.data.tags.length > 0 &&
          study.data.tags.map((tag) => (
            <span class="bg-gray-100 dark:bg-gray-800 text-gray-600 dark:text-gray-400 px-3 py-1 rounded-full text-sm">
              {tag}
            </span>
          ))
      }
    </div>
  </section>

  <!-- Related Case Studies -->
  <RelatedCaseStudies currentStudy={study} allStudies={allCaseStudies} />

  <!-- CTA Section -->
  <div class="cta-section">
    <CallToAction
      title="Ready to Transform Your Business?"
      subtitle="Let's discuss how we can help you achieve similar results"
      actions={[
        {
          variant: 'primary',
          text: 'Start Your Project',
          href: '/contact',
          icon: 'tabler:message-circle',
        },
        {
          text: 'View More Case Studies',
          href: '/case-studies',
        },
      ]}
    />
  </div>
</Layout>

<style>
  .prose {
    color: inherit;
  }

  .prose h1,
  .prose h2,
  .prose h3,
  .prose h4,
  .prose h5,
  .prose h6 {
    color: inherit;
  }

  .prose a {
    color: var(--aw-color-primary);
    text-decoration: none;
  }

  .prose a:hover {
    text-decoration: underline;
  }
</style>
